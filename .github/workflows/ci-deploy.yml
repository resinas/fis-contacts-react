name: CI - Build and Push Image

on:
    push:
        branches: [main]
        tags: ['v*.*.*']

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test

            

    build-and-push:
        needs: test
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build image
              run: |
                  IMAGE_TAG=${{ github.sha }}
                  if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                      IMAGE_TAG=${{ github.ref_name }}
                  fi
                  docker build \
                     -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
                     -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                     .
                  echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

            - name: Push image
              run: |
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest